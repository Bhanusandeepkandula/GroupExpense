<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üí∏ Group Expense Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  
  <style>
    body { font-family: 'Manrope', sans-serif; }
    .chip {
      background-color: #f0f0f0;
      color: #333;
      padding: 4px 10px;
      border-radius: 9999px;
      display: inline-block;
      margin: 2px;
      font-size: 0.875rem;
    }
    @media (max-width: 640px) {
      .responsive-table th, .responsive-table td {
        padding: 4px 2px;
        font-size: 0.875rem;
      }
    }
    .table-row {
      transition: all 0.2s;
    }
    .table-row:hover {
      background-color: #f8f8f8;
    }
    .user-balance {
      transition: all 0.3s;
    }
    .user-balance:hover {
      transform: scale(1.05);
    }
    .tab {
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 8px 8px 0 0;
    }
    .tab.active {
      background-color: #f3f4f6;
      font-weight: bold;
      border-bottom: 2px solid #3b82f6;
    }
  </style>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB-domZ-auX6gjlVd8PUtQNejIbnI6s4pU",
      authDomain: "babai-bd396.firebaseapp.com",
      databaseURL: "https://babai-bd396-default-rtdb.firebaseio.com",
      projectId: "babai-bd396",
      storageBucket: "babai-bd396.appspot.com",
      messagingSenderId: "35426041175",
      appId: "1:35426041175:web:062b896e01dcb17c325212",
      measurementId: "G-ZCHCMW26LF"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const users = { "6301": "Babai", "2806": "Harsha", "6969": "Nihal", "0400": "Kiwi" };
    const userList = ["Babai", "Harsha", "Nihal", "Kiwi"];
    let expenses = [];
    let editIndex = -1;
    let currentUser = null;
    let currentView = "all"; // "all", "weekly", "monthly", "user"

    // Initialize the app
    function initApp() {
      loadExpenses();
      updateSessionByTime();
      document.getElementById('date').valueAsDate = new Date();
    }

    // Login functionality
    function validateLogin() {
      const code = document.getElementById("loginCode").value;
      if (users[code]) {
        currentUser = users[code];
        localStorage.setItem("userLoggedIn", currentUser);
        showMainApp(currentUser);
      } else {
        showAlert("‚ùå Wrong 4-digit code. Please try again.");
      }
    }

    function showMainApp(userName) {
      document.getElementById("loginContainer").classList.add("hidden");
      document.getElementById("appContent").classList.remove("hidden");
      document.getElementById("recordedBy").value = userName;
      document.getElementById("heading").innerText = `üë• ${userName}'s Group Expense Tracker`;
      showAlert(`‚úÖ Welcome, ${userName}!`);
      initApp();
    }

    function logout() {
      localStorage.removeItem("userLoggedIn");
      currentUser = null;
      location.reload();
    }

    // Alert system
    function showAlert(message, type = 'error') {
      const alertBox = document.getElementById("alertBox");
      alertBox.textContent = message;
      alertBox.className = `fixed top-5 right-5 px-4 py-2 rounded shadow transition-opacity ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white opacity-100`;
      setTimeout(() => alertBox.classList.add("opacity-0"), 3000);
    }

    // Time-based session detection
    function updateSessionByTime() {
      const hour = new Date().getHours();
      const session = document.getElementById("session");
      if (hour < 12) session.value = "Morning";
      else if (hour < 17) session.value = "Afternoon";
      else session.value = "Evening";
    }

    // People selection chips
    function updateSelectedChips() {
      const chipsContainer = document.getElementById("selectedChips");
      chipsContainer.innerHTML = '';
      const checkboxes = document.querySelectorAll('.personCheck:checked');
      
      checkboxes.forEach(checkbox => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = checkbox.value;
        chipsContainer.appendChild(chip);
      });
      
      // Update each pays amount when people selection changes
      updateEachPays();
    }

    function toggleAllCheckboxes(source) {
      const checkboxes = document.querySelectorAll('.personCheck');
      checkboxes.forEach(checkbox => {
        checkbox.checked = source.checked;
      });
      updateSelectedChips();
    }
    
   function updateEachPays() {
  const amount = parseFloat(document.getElementById('amount').value);
  const type = document.getElementById('type').value;
  const checkboxes = document.querySelectorAll('.personCheck:checked');
  const splitInfo = document.getElementById('splitInfo');

  if (isNaN(amount)) {
    document.getElementById('eachPaysDisplay').textContent = "0.00";
    splitInfo.textContent = "";
    return;
  }

  if (type === 'Credit') {
    document.getElementById('eachPaysDisplay').textContent = amount.toFixed(2);
    splitInfo.textContent = "(Full amount received)";
  } else {
    if (checkboxes.length === 0) {
      document.getElementById('eachPaysDisplay').textContent = "0.00";
      splitInfo.textContent = "(No one selected)";
      return;
    }
    const eachPays = amount / checkboxes.length;
    document.getElementById('eachPaysDisplay').textContent = eachPays.toFixed(2);
    splitInfo.textContent = `(Split among ${checkboxes.length} ${checkboxes.length === 1 ? "person" : "people"})`;
  }
}



    // Expense CRUD operations with Firebase
    function loadExpenses() {
      const expensesRef = database.ref('expenses');
      expensesRef.orderByChild('timestamp').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          // Convert object to array and sort by timestamp (newest first)
          expenses = Object.entries(data).map(([key, value]) => ({ id: key, ...value }));
          expenses.sort((a, b) => b.timestamp - a.timestamp);
        } else {
          expenses = [];
        }
        renderExpenses();
        updateTotals();
        updateUserBalances();
      });
    }

    function addEntry(e) {
      e.preventDefault();
      
      const date = document.getElementById('date').value;
      const session = document.getElementById('session').value;
      const type = document.getElementById('type').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const category = document.getElementById('category').value;
      const notes = document.getElementById('notes').value;
      const recordedBy = document.getElementById('recordedBy').value;
      
      const people = [];
      document.querySelectorAll('.personCheck:checked').forEach(checkbox => {
        people.push(checkbox.value);
      });
      
      if (!date || !amount || isNaN(amount) || people.length === 0) {
        showAlert("‚ùå Please fill all required fields (Date, Amount, and select at least one person)");
        return;
      }
      
      const eachPays = type === 'Credit' ? amount : (amount / people.length);
      
      const entry = {
        date,
        session,
        type,
        amount,
        category,
        notes,
        recordedBy,
        people,
        eachPays,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      
      const expensesRef = database.ref('expenses');
      
      if (editIndex >= 0) {
        // Update existing expense
        const expenseId = expenses[editIndex].id;
        database.ref(`expenses/${expenseId}`).update(entry)
          .then(() => {
            editIndex = -1;
            document.querySelector('button[onclick="addEntry(event)"]').textContent = '+ Add Entry';
            showAlert("‚úÖ Expense updated successfully!", 'success');
            resetForm();
          })
          .catch((error) => {
            showAlert("‚ùå Error updating expense: " + error.message);
          });
      } else {
        // Add new expense
        expensesRef.push(entry)
          .then(() => {
            showAlert("‚úÖ Expense added successfully!", 'success');
            resetForm();
          })
          .catch((error) => {
            showAlert("‚ùå Error adding expense: " + error.message);
          });
      }
    }

    function editEntry(index) {
      const entry = expenses[index];
      document.getElementById('date').value = entry.date;
      document.getElementById('session').value = entry.session;
      document.getElementById('type').value = entry.type;
      document.getElementById('amount').value = entry.amount;
      document.getElementById('category').value = entry.category;
      document.getElementById('notes').value = entry.notes;
      document.getElementById('recordedBy').value = entry.recordedBy;
      
      // Clear all checkboxes first
      document.querySelectorAll('.personCheck').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Check the boxes for people in this entry
      entry.people.forEach(person => {
        document.querySelector(`.personCheck[value="${person}"]`).checked = true;
      });
      
      updateSelectedChips();
      editIndex = index;
      document.querySelector('button[onclick="addEntry(event)"]').textContent = 'Update Entry';
      document.getElementById('eachPaysDisplay').textContent = entry.eachPays.toFixed(2);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteEntry(index) {
      if (confirm('Are you sure you want to delete this expense?')) {
        const expenseId = expenses[index].id;
        database.ref(`expenses/${expenseId}`).remove()
          .then(() => {
            showAlert("üóëÔ∏è Expense deleted successfully!", 'success');
          })
          .catch((error) => {
            showAlert("‚ùå Error deleting expense: " + error.message);
          });
      }
    }

    function resetForm() {
      document.querySelector('form').reset();
      document.getElementById('selectedChips').innerHTML = '';
      document.getElementById('date').valueAsDate = new Date();
      document.getElementById('eachPaysDisplay').textContent = '0.00';
      updateSessionByTime();
      editIndex = -1;
      document.querySelector('button[onclick="addEntry(event)"]').textContent = '+ Add Entry';
    }

    function renderExpenses() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      
      let filteredExpenses = expenses;
      
      // Apply filters based on current view
      const now = new Date();
      switch(currentView) {
        case "weekly":
          const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          filteredExpenses = expenses.filter(exp => new Date(exp.date) >= oneWeekAgo);
          break;
        case "monthly":
          const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
          filteredExpenses = expenses.filter(exp => new Date(exp.date) >= oneMonthAgo);
          break;
        case "user":
          filteredExpenses = expenses.filter(exp => exp.people.includes(currentUser) || exp.recordedBy === currentUser);
          break;
      }
      
      if (filteredExpenses.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="10" class="py-4 text-center text-gray-500">No expenses found</td>`;
        tbody.appendChild(row);
        return;
      }
      
      filteredExpenses.forEach((expense, index) => {
        const row = document.createElement('tr');
        row.className = 'table-row border-b';
        
        // Format people list with icons
        const peopleList = expense.people.map(p => 
          `<span class="inline-flex items-center bg-gray-100 px-2 py-1 rounded-full text-xs mr-1">
            ${p}
          </span>`
        ).join('');
        
        row.innerHTML = `
          <td class="py-3 px-2 whitespace-nowrap">${formatDateShort(expense.date)}</td>
          <td class="px-2">${expense.session.charAt(0)}</td>
          <td class="px-2 ${expense.type === 'Credit' ? 'text-green-500' : 'text-red-500'}">${expense.type.charAt(0)}</td>
          <td class="px-2 font-medium">$${expense.amount.toFixed(2)}</td>
          <td class="px-2">${expense.category || '-'}</td>
          <td class="px-2 truncate max-w-xs">${expense.notes || '-'}</td>
          <td class="px-2">${peopleList}</td>
          <td class="px-2">$${expense.eachPays.toFixed(2)}</td>
          <td class="px-2">${expense.recordedBy}</td>
          <td class="px-2 whitespace-nowrap">
            <button onclick="editEntry(${expenses.findIndex(e => e.id === expense.id)})" class="text-blue-500 hover:text-blue-700 mr-2">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteEntry(${expenses.findIndex(e => e.id === expense.id)})" class="text-red-500 hover:text-red-700">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function formatDateShort(dateString) {
      const date = new Date(dateString);
      return `${date.getDate()}/${date.getMonth()+1}`;
    }

    function updateTotals() {
      let totalIncome = 0;
      let totalExpense = 0;
      
      expenses.forEach(expense => {
        if (expense.type === 'Credit') {
          totalIncome += expense.amount;
        } else {
          totalExpense += expense.amount;
        }
      });
      
      document.getElementById('totalIncome').textContent = totalIncome.toFixed(2);
      document.getElementById('totalExpense').textContent = totalExpense.toFixed(2);
      document.getElementById('netBalance').textContent = (totalIncome - totalExpense).toFixed(2);
    }
    
    function updateUserBalances() {
      const balances = {};
      userList.forEach(user => {
        balances[user] = 0;
      });
      
      expenses.forEach(expense => {
        if (expense.type === 'Credit') {
          // Credit is added to the recordedBy user
          balances[expense.recordedBy] += expense.amount;
        } else {
          // Debit is split among selected people
          const eachPays = expense.amount / expense.people.length;
          expense.people.forEach(person => {
            balances[person] -= eachPays;
          });
          // Recorded by person gets the full amount (they paid it)
          balances[expense.recordedBy] += expense.amount;
        }
      });
      
      // Update the UI
      const container = document.getElementById('userBalances');
      container.innerHTML = '';
      
      userList.forEach(user => {
        const balance = balances[user];
        const balanceElement = document.createElement('div');
        balanceElement.className = `user-balance bg-white rounded p-4 font-bold shadow border text-center ${
          balance > 0 ? 'text-green-600' : balance < 0 ? 'text-red-500' : 'text-gray-600'
        }`;
        balanceElement.innerHTML = `
          <div class="text-sm">${user}</div>
          <div class="text-xl">$${balance.toFixed(2)}</div>
          ${balance > 0 ? '<div class="text-xs mt-1">Gets back</div>' : 
           balance < 0 ? '<div class="text-xs mt-1">Owes</div>' : ''}
        `;
        container.appendChild(balanceElement);
      });
    }
    
    function changeView(view) {
      currentView = view;
      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(`view-${view}`).classList.add('active');
      renderExpenses();
    }

    // Initialize on DOM load
    document.addEventListener("DOMContentLoaded", () => {
      // Check if user is already logged in
      const storedUser = localStorage.getItem("userLoggedIn");
      if (storedUser) {
        showMainApp(storedUser);
      }
      
      // Add event listeners for dynamic updates
      document.getElementById('amount').addEventListener('input', updateEachPays);
      document.getElementById('type').addEventListener('change', updateEachPays);
    });
  </script>
</head>
<body class="bg-white text-black min-h-screen">
  <div id="loginContainer" class="flex items-center justify-center min-h-screen">
    <div class="max-w-sm mx-auto p-6 bg-gray-100 rounded-xl shadow-lg text-center">
      <h2 class="text-2xl font-semibold mb-6">üëã Expense Tracker</h2>
      <div class="mb-6">
        <input id="loginCode" type="password" maxlength="4" placeholder="Enter 4-digit code" 
               class="w-full mb-4 px-4 py-3 border rounded text-center text-lg" 
               onkeypress="if(event.key === 'Enter') validateLogin()" />
        <button onclick="validateLogin()" class="w-full bg-black text-white py-3 rounded hover:bg-gray-800 text-lg">
          Login
        </button>
      </div>
      <p class="text-gray-600 text-sm">Enter your unique 4-digit code to access the tracker</p>
    </div>
  </div>

  <div id="appContent" class="hidden px-4 max-w-6xl mx-auto pb-10">
    <div id="alertBox" class="fixed top-5 right-5 px-4 py-2 rounded shadow opacity-0 transition-opacity"></div>
    
    <div class="flex justify-between items-center py-4 border-b">
      <h1 id="heading" class="text-2xl font-bold">üë• Group Expense Tracker</h1>
      <button onclick="logout()" class="bg-black text-white px-4 py-2 rounded hover:opacity-90">Logout</button>
    </div>

    <!-- Form and Table Area -->
    <form class="bg-gray-100 p-6 rounded-xl shadow-md space-y-4 mb-6 mt-6">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Date</label>
          <input type="date" id="date" class="w-full px-4 py-2 rounded border" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Session</label>
          <select id="session" class="w-full px-4 py-2 rounded border">
            <option>Morning</option>
            <option>Afternoon</option>
            <option>Evening</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Type</label>
          <select id="type" class="w-full px-4 py-2 rounded border">
            <option>Credit</option>
            <option>Debit</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Amount ($)</label>
          <input type="number" id="amount" placeholder="0.00" step="0.01" 
                 class="w-full px-4 py-2 rounded border" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Category</label>
          <input type="text" id="category" placeholder="Food, Rent, etc." 
                 class="w-full px-4 py-2 rounded border" />
        </div>
        <div>
  <label class="block text-sm font-medium mb-1">Each Pays</label>
  <div class="w-full px-4 py-2 rounded border bg-gray-50">
    $<span id="eachPaysDisplay">0.00</span>
    <span id="splitInfo" class="text-sm text-gray-500 ml-2"></span> <!-- üëà Add this line -->
  </div>
</div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Recorded by</label>
          <select id="recordedBy" class="w-full px-4 py-2 rounded border">
            <option>Babai</option>
            <option>Harsha</option>
            <option>Nihal</option>
            <option>Kiwi</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Shared With</label>
          <div class="relative">
            <button type="button" onclick="document.getElementById('peopleMenu').classList.toggle('hidden')" 
                    class="w-full px-4 py-2 rounded border bg-white text-left flex justify-between items-center">
              <span>Select People</span>
              <i class="fas fa-chevron-down"></i>
            </button>
            <div id="peopleMenu" class="absolute bg-white shadow rounded p-2 mt-1 hidden z-10 w-full border">
              <label class="block p-1 hover:bg-gray-100 rounded"><input type="checkbox" class="personCheck" value="Babai" onchange="updateSelectedChips()" /> Babai</label>
              <label class="block p-1 hover:bg-gray-100 rounded"><input type="checkbox" class="personCheck" value="Harsha" onchange="updateSelectedChips()" /> Harsha</label>
              <label class="block p-1 hover:bg-gray-100 rounded"><input type="checkbox" class="personCheck" value="Nihal" onchange="updateSelectedChips()" /> Nihal</label>
              <label class="block p-1 hover:bg-gray-100 rounded"><input type="checkbox" class="personCheck" value="Kiwi" onchange="updateSelectedChips()" /> Kiwi</label>
              <hr class="my-1 border-gray-200">
              <label class="block p-1 hover:bg-gray-100 rounded"><input type="checkbox" onchange="toggleAllCheckboxes(this)" /> <strong>Select All</strong></label>
            </div>
            <div id="selectedChips" class="mt-2 flex flex-wrap"></div>
          </div>
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Notes</label>
          <input type="text" id="notes" placeholder="Additional details" 
                 class="w-full px-4 py-2 rounded border" />
        </div>
      </div>
      <div class="flex space-x-2">
        <button onclick="addEntry(event)" class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600">
          <i class="fas fa-plus mr-2"></i> Add Entry
        </button>
        <button type="button" onclick="resetForm()" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </form>

    <!-- View Tabs -->
    <div class="flex border-b mb-4">
      <div id="view-all" class="tab view-tab active" onclick="changeView('all')">All Expenses</div>
      <div id="view-weekly" class="tab view-tab" onclick="changeView('weekly')">Weekly</div>
      <div id="view-monthly" class="tab view-tab" onclick="changeView('monthly')">Monthly</div>
      <div id="view-user" class="tab view-tab" onclick="changeView('user')">My Expenses</div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-6">
      <div class="bg-white rounded p-4 font-bold text-green-600 shadow border">
        <div class="text-sm">üí∞ Total Income</div>
        <div class="text-xl">$<span id="totalIncome">0.00</span></div>
      </div>
      <div class="bg-white rounded p-4 font-bold text-red-500 shadow border">
        <div class="text-sm">üìâ Total Expense</div>
        <div class="text-xl">$<span id="totalExpense">0.00</span></div>
      </div>
      <div class="bg-white rounded p-4 font-bold text-blue-500 shadow border">
        <div class="text-sm">‚öñÔ∏è Net Balance</div>
        <div class="text-xl">$<span id="netBalance">0.00</span></div>
      </div>
    </div>

    <!-- User Balances -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">üë• User Balances</h3>
      <div id="userBalances" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
    </div>

    <!-- Expenses Table -->
    <div class="overflow-x-auto bg-white rounded-lg shadow border">
      <table class="w-full responsive-table">
        <thead>
          <tr class="text-left border-b bg-gray-100">
            <th class="p-2 whitespace-nowrap">Date</th>
            <th class="p-2">Ses</th>
            <th class="p-2">T</th>
            <th class="p-2">Amount</th>
            <th class="p-2">Category</th>
            <th class="p-2">Notes</th>
            <th class="p-2">People</th>
            <th class="p-2">Each</th>
            <th class="p-2">By</th>
            <th class="p-2">Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</body>
</html>