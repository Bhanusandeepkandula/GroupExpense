<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Group Expense Tracker</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- Work Sans -->
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    body { font-family:'Work Sans',sans-serif; background:#f8fafc; color:#1f2937 }
    .card { background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.05); transition:.2s }
    .card:hover { box-shadow:0 4px 12px rgba(0,0,0,0.1) }
    .form-input { border:1px solid #e2e8f0; border-radius:8px; transition:.2s }
    .form-input:focus { border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.1) }
    .btn-primary { background:#3b82f6; border-radius:8px; transition:.2s }
    .btn-primary:hover { background:#2563eb }
    /* Chips */
    #selectedChips { position:absolute; top:100%; left:0; right:0; margin-top:.25rem;
      background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:.5rem;
      display:flex; flex-wrap:wrap; gap:.25rem; z-index:20
    }
    #selectedChips.hidden { display:none }
    /* Balances */
    .balance-card { border-radius:8px; padding:1rem; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,0.1) }
    .balance-card.positive { border:1px solid #a7f3d0; background:#ecfdf5; color:#065f46 }
    .balance-card.negative { border:1px solid #fecaca; background:#fef2f2; color:#7f1d1d }
  </style>
</head>
<body class="antialiased">

  <!-- LOGIN -->
  <div id="loginContainer" class="min-h-screen flex items-center justify-center bg-gray-50 px-4">
    <div class="w-full max-w-md p-8 card">
      <div class="text-center mb-6">
        <i class="fas fa-wallet text-blue-500 text-4xl mb-2"></i>
        <h2 class="text-2xl font-semibold">Expense Tracker</h2>
        <p class="text-gray-500">Enter your 4‑digit code</p>
      </div>
      <input id="loginCode" type="password" maxlength="4" placeholder="XXXX"
             class="w-full mb-4 px-4 py-2 form-input text-center text-lg" />
      <button onclick="validateLogin()"
              class="w-full btn-primary text-white py-2 font-medium flex items-center justify-center gap-2">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>
    </div>
  </div>

  <!-- APP -->
  <div id="appContent" class="hidden px-4 pt-8 pb-16 max-w-5xl mx-auto">

    <!-- HEADER -->
    <div class="flex justify-between items-center mb-6">
      <h1 id="heading" class="text-2xl font-semibold flex items-center gap-2">
        <i class="fas fa-wallet text-blue-500"></i>Tracker
      </h1>
      <button onclick="logout()"
              class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-gray-900">
        Logout
      </button>
    </div>

    <!-- FILTERS & ACTIONS -->
    <div class="card p-4 mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-center">
      <select id="viewFilter" onchange="applyFilters()" class="form-input px-3 py-2">
        <option value="all">All</option>
        <option value="weekly">Last 7 days</option>
        <option value="monthly">Last 30 days</option>
        <option value="mine">Mine</option>
      </select>
      <div class="flex gap-2 items-center">
        <input type="date" id="startDate" onchange="applyFilters()" class="form-input px-2 py-1"/>
        <span>to</span>
        <input type="date" id="endDate" onchange="applyFilters()" class="form-input px-2 py-1"/>
      </div>
      <button onclick="exportCSV()" class="btn-primary text-white px-4 py-2 flex items-center justify-center">
        <i class="fas fa-file-export mr-2"></i> Export
      </button>
      <button onclick="showAnalytics()" class="btn-primary text-white px-4 py-2 flex items-center justify-center">
        <i class="fas fa-chart-pie mr-2"></i> Analytics
      </button>
    </div>

    <!-- ADD EXPENSE -->
    <div class="card p-6 mb-8">
      <h2 class="text-xl font-medium flex items-center gap-2 mb-4">
        <i class="fas fa-plus-circle text-blue-500"></i>Add Expense
      </h2>
      <form onsubmit="addEntry(event)" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
        <div>
          <label class="block text-sm font-medium mb-1">Date</label>
          <input id="date" type="date" class="w-full form-input px-3 py-2" required/>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Session</label>
          <select id="session" class="w-full form-input px-3 py-2">
            <option>Morning</option><option>Afternoon</option><option>Evening</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Type</label>
          <select id="type" class="w-full form-input px-3 py-2" onchange="updateEachPays()">
            <option>Credit</option><option>Debit</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Amount</label>
          <input id="amount" type="number" step="0.01" placeholder="0.00"
                 class="w-full form-input px-3 py-2" oninput="updateEachPays()" required/>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Category</label>
          <input id="category" type="text" placeholder="e.g. Food"
                 class="w-full form-input px-3 py-2"/>
        </div>
        <div class="relative">
          <label class="block text-sm font-medium mb-1">Shared With</label>
          <button type="button" onclick="togglePeopleMenu()"
                  class="w-full form-input px-3 py-2 flex justify-between items-center">
            <span>Select people</span>
            <i class="fas fa-chevron-down text-gray-400"></i>
          </button>
          <div id="selectedChips" class="hidden"></div>
          <div id="peopleMenu"
               class="absolute inset-x-0 top-full bg-white border rounded-md shadow-lg mt-1 z-10 max-h-48 overflow-auto hidden">
            <label class="flex items-center p-2 hover:bg-gray-100">
              <input type="checkbox" class="personCheck mr-2" value="Babai" onchange="updateSelectedChips()"/>Babai
            </label>
            <label class="flex items-center p-2 hover:bg-gray-100">
              <input type="checkbox" class="personCheck mr-2" value="Harsha" onchange="updateSelectedChips()"/>Harsha
            </label>
            <label class="flex items-center p-2 hover:bg-gray-100">
              <input type="checkbox" class="personCheck mr-2" value="Nihal" onchange="updateSelectedChips()"/>Nihal
            </label>
            <label class="flex items-center p-2 hover:bg-gray-100">
              <input type="checkbox" class="personCheck mr-2" value="Kiwi" onchange="updateSelectedChips()"/>Kiwi
            </label>
            <hr class="my-2"/>
            <label class="flex items-center p-2 hover:bg-gray-100">
              <input type="checkbox" onclick="toggleAllCheckboxes(this)" class="mr-2"/>Select All
            </label>
          </div>
        </div>
        <div class="sm:col-span-2 lg:col-span-2">
          <label class="block text-sm font-medium mb-1">Notes</label>
          <input id="notes" type="text" placeholder="Add details…"
                 class="w-full form-input px-3 py-2"/>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Split Amount</label>
          <div class="w-full form-input px-3 py-2 bg-gray-50 rounded-md flex justify-between">
            <span>$<span id="eachPaysDisplay">0.00</span></span>
            <span id="splitInfo" class="text-gray-500 text-xs">Select people</span>
          </div>
        </div>
        <div class="sm:col-span-2 flex justify-end space-x-4">
          <button type="button" onclick="resetForm()"
                  class="px-6 py-2 border rounded-md text-gray-700 hover:bg-gray-100">
            Clear
          </button>
          <button type="submit"
                  class="btn-primary px-6 py-2 text-white">
            Add
          </button>
        </div>
      </form>
    </div>

    <!-- SUMMARY CARDS -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
      <div class="card p-4 flex items-center justify-between">
        <div>
          <div class="text-sm text-gray-600 flex items-center gap-1">
            <i class="fas fa-arrow-up text-green-500"></i>Total Income
          </div>
          <div id="totalIncome" class="text-2xl font-bold text-green-600">$0.00</div>
        </div>
        <i class="fas fa-coins text-green-500 text-2xl"></i>
      </div>
      <div class="card p-4 flex items-center justify-between">
        <div>
          <div class="text-sm text-gray-600 flex items-center gap-1">
            <i class="fas fa-arrow-down text-red-500"></i>Total Expense
          </div>
          <div id="totalExpense" class="text-2xl font-bold text-red-600">$0.00</div>
        </div>
        <i class="fas fa-receipt text-red-500 text-2xl"></i>
      </div>
      <div class="card p-4 flex items-center justify-between">
        <div>
          <div class="text-sm text-gray-600 flex items-center gap-1">
            <i class="fas fa-balance-scale text-blue-500"></i>Net Balance
          </div>
          <div id="netBalance" class="text-2xl font-bold text-blue-600">$0.00</div>
        </div>
        <i class="fas fa-scale-balanced text-blue-500 text-2xl"></i>
      </div>
    </div>

    <!-- USER BALANCES -->
    <section class="mb-8">
      <h2 class="text-xl font-medium mb-4 flex items-center gap-2">
        <i class="fas fa-users text-blue-500"></i>User Balances
      </h2>
      <div id="userBalances" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <!-- TRANSACTIONS TABLE -->
    <section>
      <h2 class="text-xl font-medium mb-4">Transactions</h2>
      <div class="overflow-auto card">
        <table class="w-full text-left border-collapse">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-3">Date</th><th class="p-3">Time</th><th class="p-3">Type</th>
              <th class="p-3">Amount</th><th class="p-3">Category</th><th class="p-3">Notes</th>
              <th class="p-3">People</th><th class="p-3">Each</th><th class="p-3">By</th>
              <th class="p-3">Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>

  </div><!-- /APP -->

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

  <script>
    // ── Firebase config ──
    const firebaseConfig = {
      apiKey: "AIzaSyB-domZ-auX6gjlVd8PUtQNejIbnI6s4pU",
      authDomain: "babai-bd396.firebaseapp.com",
      databaseURL: "https://babai-bd396-default-rtdb.firebaseio.com",
      projectId: "babai-bd396",
      storageBucket: "babai-bd396.appspot.com",
      messagingSenderId: "35426041175",
      appId: "1:35426041175:web:062b896e01dcb17c325212",
      measurementId: "G-ZCHCMW26LF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ── State ──
    const users = {"6301":"Babai","2806":"Harsha","6969":"Nihal","0400":"Kiwi"};
    let currentUser = null, expenses = [], editIndex = -1;

    // ── Login ──
    function validateLogin(){
      const code = document.getElementById("loginCode").value.trim();
      if(users[code]){
        currentUser = users[code];
        localStorage.setItem("userLoggedIn", currentUser);
        showMainApp();
      } else {
        alert("Invalid code");
      }
    }
    function showMainApp(){
      document.getElementById("loginContainer").classList.add("hidden");
      document.getElementById("appContent").classList.remove("hidden");
      document.getElementById("heading").innerText = `${currentUser}'s Tracker`;
      initApp();
    }
    function logout(){
      localStorage.removeItem("userLoggedIn");
      location.reload();
    }
    document.addEventListener("DOMContentLoaded", ()=>{
      const saved = localStorage.getItem("userLoggedIn");
      if(saved){ currentUser = saved; showMainApp(); }
      document.getElementById("loginCode")
        .addEventListener("keydown", e=>{ if(e.key==="Enter") validateLogin(); });
    });

    // ── Shared UI ──
    function togglePeopleMenu(){
      document.getElementById("peopleMenu").classList.toggle("hidden");
      document.getElementById("selectedChips").classList.add("hidden");
    }
    function updateSelectedChips(){
      const cont = document.getElementById("selectedChips");
      cont.innerHTML = "";
      document.querySelectorAll(".personCheck:checked").forEach(cb=>{
        const s = document.createElement("span");
        s.className="px-2 py-1 bg-gray-100 rounded-full text-sm flex items-center gap-1";
        s.innerHTML = `<i class="fas fa-user text-xs"></i>${cb.value}`;
        cont.appendChild(s);
      });
      cont.classList[ cont.children.length ? "remove":"add" ]("hidden");
      updateEachPays();
    }
    function toggleAllCheckboxes(master){
      document.querySelectorAll(".personCheck").forEach(cb=>cb.checked=master.checked);
      updateSelectedChips();
    }

    // ── Split logic ──
    function updateEachPays(){
      const amt = parseFloat(document.getElementById("amount").value)||0;
      const sel = document.querySelectorAll(".personCheck:checked").length;
      const type= document.getElementById("type").value;
      let each=0;
      if(type==="Credit"){ each=amt; document.getElementById("splitInfo").innerText="Full to recorder"; }
      else if(sel){ each=amt/sel; document.getElementById("splitInfo").innerText=`Split among ${sel}`; }
      else document.getElementById("splitInfo").innerText="Select people";
      document.getElementById("eachPaysDisplay").innerText=each.toFixed(2);
    }

    // ── Init & CRUD ──
    function initApp(){
      loadExpenses();
      document.getElementById("date").valueAsDate=new Date();
      document.getElementById("amount").addEventListener("input",updateEachPays);
      document.getElementById("type").addEventListener("change",updateEachPays);
    }
    function addEntry(e){
      e.preventDefault();
      const entry={
        date:document.getElementById("date").value,
        session:document.getElementById("session").value,
        type:document.getElementById("type").value,
        amount:parseFloat(document.getElementById("amount").value)||0,
        category:document.getElementById("category").value,
        notes:document.getElementById("notes").value,
        recordedBy:currentUser,
        people:Array.from(document.querySelectorAll(".personCheck:checked")).map(cb=>cb.value),
        eachPays:parseFloat(document.getElementById("eachPaysDisplay").innerText)||0,
        timestamp:firebase.database.ServerValue.TIMESTAMP
      };
      if(!entry.date||!entry.people.length){
        alert("Fill Date & Shared With"); return;
      }
      db.ref("expenses").push(entry)
        .then(()=>{ resetForm(); applyFilters(); })
        .catch(err=>alert("Add failed:"+err.message));
    }
    function resetForm(){
      document.querySelector("form").reset();
      document.getElementById("selectedChips").classList.add("hidden");
      document.getElementById("peopleMenu").classList.add("hidden");
      document.getElementById("date").valueAsDate=new Date();
      updateEachPays();
    }
    function loadExpenses(){
      db.ref("expenses").orderByChild("timestamp")
        .on("value",snap=>{
          expenses=[];
          snap.forEach(c=>expenses.push({id:c.key,...c.val()}));
          applyFilters();
        });
    }
    function applyFilters(){
      let list = [...expenses];
      const view = document.getElementById("viewFilter").value;
      const now=Date.now();
      if(view==="weekly")   list=list.filter(e=>e.timestamp>now-7*24*3600*1000);
      if(view==="monthly")  list=list.filter(e=>e.timestamp>now-30*24*3600*1000);
      if(view==="mine")     list=list.filter(e=>e.recordedBy===currentUser);
      const sd=document.getElementById("startDate").value;
      const ed=document.getElementById("endDate").value;
      if(sd&&ed){
        const s=new Date(sd), e=new Date(ed);
        list=list.filter(x=>{
          const d=new Date(x.date);
          return d>=s&&d<=e;
        });
      }
      renderExpenses(list);
      updateSummary(list);
      updateUserBalances();
    }
    function renderExpenses(list){
      const tb=document.getElementById("tableBody"); tb.innerHTML="";
      if(!list.length){
        tb.innerHTML=`<tr><td colspan=10 class="p-4 text-center text-gray-500">No expenses</td></tr>`;
        return;
      }
      list.forEach(e=>{
        const tr=document.createElement("tr"); tr.className="border-b hover:bg-gray-50";
        tr.innerHTML=`
          <td class="p-2">${e.date}</td>
          <td class="p-2">${e.session.charAt(0)}</td>
          <td class="p-2 ${e.type==='Credit'?'text-green-600':'text-red-600'}">${e.type.charAt(0)}</td>
          <td class="p-2">$${e.amount.toFixed(2)}</td>
          <td class="p-2">${e.category||"-"}</td>
          <td class="p-2">${e.notes||"-"}</td>
          <td class="p-2">${e.people.join(", ")}</td>
          <td class="p-2">$${e.eachPays.toFixed(2)}</td>
          <td class="p-2">${e.recordedBy}</td>
          <td class="p-2 space-x-2">
            <button onclick="startEdit('${e.id}')" class="text-blue-600"><i class="fas fa-edit"></i></button>
            <button onclick="deleteEntry('${e.id}')" class="text-red-600"><i class="fas fa-trash"></i></button>
          </td>`;
        tb.appendChild(tr);
      });
    }
    function updateSummary(list){
      let inc=0,exp=0;
      list.forEach(e=> e.type==="Credit"?inc+=e.amount:exp+=e.amount);
      document.getElementById("totalIncome").innerText=inc.toFixed(2);
      document.getElementById("totalExpense").innerText=exp.toFixed(2);
      document.getElementById("netBalance").innerText=(inc-exp).toFixed(2);
    }
    function updateUserBalances(){
      const bal={"Babai":0,"Harsha":0,"Nihal":0,"Kiwi":0};
      expenses.forEach(e=>{
        if(e.type==="Credit") bal[e.recordedBy]+=e.amount;
        else{
          const each=e.amount/e.people.length;
          e.people.forEach(p=>bal[p]-=each);
          bal[e.recordedBy]+=e.amount;
        }
      });
      const c=document.getElementById("userBalances"); c.innerHTML="";
      Object.entries(bal).forEach(([u,a])=>{
        const d=document.createElement("div");
        d.className="balance-card "+(a>=0?"positive":"negative");
        d.innerHTML=`<div class="font-medium">${u}</div>
                    <div class="text-2xl font-bold">$${Math.abs(a).toFixed(2)}</div>
                    <div class="mt-1 text-sm">${a>=0?"Gets back":"Owes"}</div>`;
        c.appendChild(d);
      });
    }
    function deleteEntry(id){
      db.ref(`expenses/${id}`).remove()
        .then(()=>applyFilters());
    }
    function startEdit(id){
      const e = expenses.find(x=>x.id===id);
      if(!e) return;
      editIndex=id;
      ["date","session","type","amount","category","notes"].forEach(f=>
        document.getElementById(f).value=e[f]
      );
      document.querySelectorAll(".personCheck").forEach(cb=>cb.checked=false);
      e.people.forEach(p=>{
        const cb=[...document.querySelectorAll(".personCheck")].find(x=>x.value===p);
        if(cb) cb.checked=true;
      });
      updateSelectedChips();
      document.querySelector("button[type=submit]").innerText="Save";
    }
    function exportCSV(){
      const rows = expenses.map(e=>[
        e.date, e.session, e.type,
        e.amount.toFixed(2), e.category, e.notes,
        e.people.join(';'), e.eachPays.toFixed(2), e.recordedBy
      ]);
      let csv=[["Date","Session","Type","Amount","Category","Notes","People","Each","By"],...rows]
        .map(r=>r.map(v=>`"${v}"`).join(',')).join('\r\n');
      let blob=new Blob([csv],{type:"text/csv"}),url=URL.createObjectURL(blob);
      let a=document.createElement("a");a.href=url;a.download="expenses.csv";
      document.body.appendChild(a);a.click();document.body.removeChild(a);
    }
    function showAnalytics(){
      let byCat={};
      expenses.forEach(e=> byCat[e.category]=(byCat[e.category]||0)+e.amount );
      const modal=`<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
          <h3 class="text-lg font-semibold mb-4">Analytics by Category</h3>
          ${Object.entries(byCat).map(([c,v])=>`
            <div class="flex justify-between"><span>${c||"Uncategorized"}</span><span>$${v.toFixed(2)}</span></div>
          `).join('')}
          <div class="text-right mt-4">
            <button onclick="document.body.removeChild(this.closest('div'))"
                    class="px-4 py-2 bg-gray-200 rounded">Close</button>
          </div>
        </div>
      </div>`;
      document.body.insertAdjacentHTML('beforeend', modal);
    }
  </script>
</body>
</html>
